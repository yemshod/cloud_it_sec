The error you’re encountering:

InsufficientS3BucketPolicyException: Incorrect S3 bucket policy is detected for bucket: pri-central-s3-logs

occurs because CloudTrail requires very specific S3 bucket policy statements, even when you’re setting up object-level logging from a bucket in a different AWS account (e.g., for S3 Data Events).

⸻

Why This Happens

When you configure CloudTrail (especially with Data Events) to deliver logs to an S3 bucket in a different account, CloudTrail checks whether:
	1.	The destination bucket explicitly allows cloudtrail.amazonaws.com as the principal.
	2.	The PutObject permission is scoped to the right SourceArn, SourceAccount, and expected key prefix.
	3.	The policy follows the strict AWS-prescribed format, especially for cross-account CloudTrail integration.

⸻

Required Bucket Policy Fix

Here’s the correct bucket policy you must apply to the centralized bucket (pri-central-s3-logs) in your PRI Audit account, allowing CloudTrail from other AWS accounts (e.g., 123456789012) to write to it:

{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "Allow CloudTrail from Source Account",
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudtrail.amazonaws.com"
      },
      "Action": "s3:PutObject",
      "Resource": "arn:aws:s3:::pri-central-s3-logs/AWSLogs/123456789012/*",
      "Condition": {
        "StringEquals": {
          "s3:x-amz-acl": "bucket-owner-full-control"
        }
      }
    }
  ]
}

Key Notes:
	•	Replace 123456789012 with the actual source account ID.
	•	Ensure your CloudTrail trail is configured to deliver logs under the path AWSLogs/<account-id>/.

⸻

Additional Required Configurations

1. Enable bucket-owner-full-control ACL on CloudTrail

CloudTrail must be configured with:

s3_bucket_name          = "pri-central-s3-logs"
s3_key_prefix           = "AWSLogs/123456789012"
s3_bucket_owner         = "AUDIT_ACCOUNT_ID" # Needed for cross-account
include_global_service_events = true
is_multi_region_trail  = true

2. Ensure Ownership Controls on the Central Bucket

You must ensure the centralized bucket has:

resource "aws_s3_bucket_ownership_controls" "central" {
  bucket = aws_s3_bucket.central.id
  rule {
    object_ownership = "BucketOwnerPreferred"
  }
}

This guarantees the Audit account retains ownership even when another account writes logs with ACLs.

⸻

Fix Flow Summary

Task	Description
Fix Bucket Policy	Add CloudTrail-specific s3:PutObject policy for each source account, with correct path and bucket-owner-full-control
Ensure ACL	CloudTrail must use ACL bucket-owner-full-control during log delivery
Set Ownership Controls	Set object_ownership = BucketOwnerPreferred
Prefix Path	CloudTrail must use path like AWSLogs/<account-id>/ or the S3 key prefix must match the policy
Validate Cross-Account Setup	Confirm the trail’s s3_bucket_owner is set to the Audit account ID if configured from a different account



⸻

Would you like a Terraform version of this specific CloudTrail-compatible S3 bucket policy for your centralized logging bucket?


---------

Below is the corrected Terraform-compatible aws_s3_bucket_policy block that supports CloudTrail cross-account delivery to your pri-central-s3-logs bucket, following the style of the code in your image and integrating bucket-owner-full-control ACL and AWSLogs/<account-id>/* prefix:

resource "aws_s3_bucket_policy" "central_logs" {
  bucket = aws_s3_bucket.central_logs.id

  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [
      {
        Sid       = "AllowCloudTrailLogsFromSourceAccounts",
        Effect    = "Allow",
        Principal = {
          Service = "cloudtrail.amazonaws.com"
        },
        Action    = "s3:PutObject",
        Resource  = var.allowed_source_accounts[*] != null ? [
          for account in var.allowed_source_accounts :
          "${aws_s3_bucket.central_logs.arn}/AWSLogs/${account}/*"
        ] : [],
        Condition = {
          StringEquals = {
            "s3:x-amz-acl" = "bucket-owner-full-control"
          }
        }
      }
    ]
  })
}



⸻

Required Variables:

variable "allowed_source_accounts" {
  description = "List of AWS account IDs allowed to send CloudTrail logs"
  type        = list(string)
}

Example Usage:

allowed_source_accounts = [
  "111111111111",
  "222222222222"


]



⸻

Important:
	•	This version assumes you’re delivering logs to paths like: s3://pri-central-s3-logs/AWSLogs/<account-id>/...
	•	You must configure CloudTrail in the source account with:
	•	s3_bucket_name = "pri-central-s3-logs"
	•	s3_key_prefix = "AWSLogs/<account-id>"
	•	s3_bucket_owner = "<Audit Account ID>"

Would you like me to wrap this into a reusable module block (like pri-cloudtrail-crossaccount-policy) or add inline comments for clarity?


##############

Below is the dynamic Terraform version of the CloudTrail-compatible aws_s3_bucket_policy using a list of account IDs and a for loop to generate the required PutObject and GetBucketAcl statements. This approach ensures clean automation across N accounts.

⸻

1. Terraform Variables

variable "log_bucket_name" {
  description = "Name of the centralized bucket"
  type        = string
  default     = "pri-central-s3-bucket-access-logs"
}

variable "trail_regions" {
  description = "List of CloudTrail regions (one per account)"
  type        = list(string)
}

variable "source_account_ids" {
  description = "List of AWS Account IDs that will send logs"
  type        = list(string)
}



⸻

2. S3 Bucket Policy Resource Using for Expressions

resource "aws_s3_bucket_policy" "central_logs" {
  bucket = var.log_bucket_name

  policy = jsonencode({
    Version = "2012-10-17",
    Statement = concat(
      [
        {
          Sid       = "AWSCloudTrailGetBucketAcl",
          Effect    = "Allow",
          Principal = { Service = "cloudtrail.amazonaws.com" },
          Action    = "s3:GetBucketAcl",
          Resource  = "arn:aws:s3:::${var.log_bucket_name}",
          Condition = {
            StringEquals = {
              "aws:SourceArn" = [
                for i in range(length(var.source_account_ids)) :
                "arn:aws:cloudtrail:${var.trail_regions[i]}:${var.source_account_ids[i]}:trail/*"
              ]
            }
          }
        }
      ],
      [
        for i in range(length(var.source_account_ids)) : {
          Sid       = "AWSCloudTrailWrite20150319-${i + 1}"
          Effect    = "Allow"
          Principal = { Service = "cloudtrail.amazonaws.com" }
          Action    = "s3:PutObject"
          Resource  = "arn:aws:s3:::${var.log_bucket_name}/AWSLogs/${var.source_account_ids[i]}/*"
          Condition = {
            StringEquals = {
              "s3:x-amz-acl"   = "bucket-owner-full-control",
              "aws:SourceArn" = "arn:aws:cloudtrail:${var.trail_regions[i]}:${var.source_account_ids[i]}:trail/*"
            }
          }
        }
      ]
    )
  })
}



⸻

3. Example Usage

source_account_ids = [
  "123456789012",
  "098765432109",
  "112233445566"
]

trail_regions = [
  "us-east-1",
  "us-west-2",
  "eu-central-1"
]



⸻

What This Does

Component	Purpose
GetBucketAcl	Allows CloudTrail to verify permissions on the destination bucket
PutObject	Allows CloudTrail to write logs from each account under AWSLogs/<account-id>/
for loop	Dynamically renders one policy statement per account/region pair



⸻

Would you like this policy separated into its own reusable module for other centralized logging scenarios (e.g., GuardDuty, Config)?
