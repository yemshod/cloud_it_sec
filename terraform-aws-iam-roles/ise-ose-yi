DNS Query Logs – Centralized Deployment Plan
Phase 0 – Preparation (One-Time Setup)

Objectives:

Establish the centralized repository and access paths before rolling out replication.

Tasks:

Central S3 Bucket Creation:

Create bucket: exacttrust-dnslogs-central (in the shared production account).

Enable versioning and SSE-KMS encryption (with a CMK scoped to AWS logging services + Wiz/Security IAM roles).

Define prefix pathing: /DNSLogs/<AccountID>/<Region>/….

Bucket Policy & KMS Key Policy:

Bucket Policy: allow s3:ReplicateObject and s3:ReplicateDelete from source DNS log buckets in the same account.

KMS Key Policy: allow encryption by source buckets’ replication role, decryption by Wiz Defend IAM role and Security Team.

IAM Role for Wiz Defend:

Create WizDefendDNSLogsReadRole with sts:ExternalId trust to Wiz.

Grant s3:GetObject, s3:ListBucket on exacttrust-dnslogs-central.

Allow kms:Decrypt on CMK.

Wiz SQS Queue Setup:

Create SQS queue in the same account (wiz-dnslogs-queue).

Configure S3 bucket event notification to publish object-created events to this SQS.

Provide Wiz with queue ARN and configure subscription.

Automation/Template Build:

Build a reusable S3 replication rule template (CloudFormation/Terraform).

Script onboarding of new region buckets.

Phase 1 – Regionized Buckets Replication Enablement

Objectives:

Point all existing regionized DNS log buckets (per-region) to replicate into the centralized bucket.

Tasks:

Identify All Source Buckets:

Inventory per-region DNS log buckets in the shared prod account.

Validate versioning is enabled on all source buckets.

Create/Attach Replication Rules:

For each region bucket, configure S3 replication to central bucket.

Ensure replication IAM role has s3:GetObject on source, s3:ReplicateObject on destination.

Test replication with sample objects.

Validate Replication:

Confirm central bucket receives replicated DNS logs within minutes.

Verify folder structure aligns with expected pathing (DNSLogs/<AccountID>/<Region>/).

Check CloudTrail for denied events.

Monitoring Setup:

Enable CloudWatch metrics/alarms for replication failures.

Track replication status reports via S3 Replication metrics.

Phase 2 – Wiz Defend Integration

Objectives:

Connect Wiz Defend to the centralized bucket via the new SQS notification stream.

Tasks:

Finalize Wiz IAM Role:

Share role ARN with Wiz Defend for onboarding.

Test AssumeRole via Wiz to confirm permissions.

Hook up Wiz SQS Queue:

Validate S3 → SQS event delivery is consistent.

Confirm Wiz Defend successfully polls and ingests log notifications.

Integration Testing:

Trigger DNS queries in test VPCs.

Verify logs land in source bucket → replicate → central bucket.

Confirm Wiz Defend displays them in near-real-time.

Phase 3 – Transition & Optimization

Objectives:

Transition fully to centralized ingestion, deprecate redundant processes, optimize retention.

Tasks:

Deprecate Direct Consumers:

If any tools (besides Wiz) currently read from regionized buckets, reconfigure them to consume from central.

Update Splunk ingestion path if needed (mirror post-implementation plan for VPC Flow Logs).

Retention & Lifecycle:

Apply lifecycle rules: 90 days hot → 1 year cold → Glacier Deep Archive (3+ years).

Ensure retention policy aligns with PCI and NIST requirements.

Compliance Controls:

Deploy AWS Config custom rule: check all DNS log buckets have replication enabled.

Alerts on non-compliance.

Phase 4 – Sustainment & Automation

Objectives:

Ensure continued compliance for new buckets and seamless integration.

Tasks:

Account/Region Onboarding:

Automate replication rule deployment for any new regional DNS log bucket created in future.

Add hook to provisioning pipelines.

Continuous Monitoring:

Daily replication lag metrics review.

Monthly test ingest flows with Wiz Defend.

Audit & Reporting:

Quarterly audit: verify log coverage across accounts/regions.

Generate compliance report showing Wiz ingestion coverage.

✅ Outcome: All DNS Query Logs across regions replicate into a single centralized bucket in the shared production account. Wiz Defend ingests logs seamlessly via SQS. Security and compliance teams maintain a single-pane-of-glass view for DNS activity across the environment.
