Title
Description
SPL Query (index=xdr)
Comment
Execution with AT (T1053)
Detects the execution of the Windows ‘at.exe’ utility to schedule tasks, which adversaries may abuse for persistence or execution (MITRE ATT&CK T1053: Scheduled Task/Job). Applicable to endpoint process logs from Defender XDR.
index=xdr | tstats count min(_time) as firstTime max(_time) as lastTime FROM datamodel=Endpoint.Processes WHERE Processes.action="allowed" AND Processes.process_path="*\\at.exe" BY Processes.process_name, Processes.process_path, Processes.process, Processes.parent_process_name, Processes.dest, Processes.user | \drop_dm_object_name(Processes)` | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | where count > 0`
Optimized for data model acceleration; monitor for unusual scheduling activity. False positives may include legitimate admin tasks.
Microsoft Defender Incident Alerts (Dynamic MITRE Mapping)
Aggregates and summarizes alerts from Microsoft Defender for O365 incidents, filtering clean verdicts and dynamically mapping to MITRE ATT&CK techniques for risk-based alerting. Correlates threats across entities like files, IPs, and processes.
index=xdr sourcetype=ms365:defender:incident:alerts (dest=* OR user=*) | eval tmp_entities=json_extract(_raw, "entities"), tmp_entitymv=json_array_to_mv(tmp_entities), tmp_filtered_mv=mvfilter(json_extract(tmp_entitymv, "verdict") != "Clean"), entityType = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "entityType")), filePath = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "filePath")), processCommandLine = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "processCommandLine")), ipAddress = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "ipAddress")), registryKey = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "registryKey")), url = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "url")) | eval tmp_filtered_mv=mvfilter(json_extract(tmp_filtered_mv, "entityType") = "File"), fileName = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "fileName")) | eval risk_score=case(severity="informational", 5, severity="low", 15, severity="medium", 25, severity="high", 50, true(), 2) | stats count min(_time) as firstTime max(_time) as lastTime values(fileName) as file_name values(severity) as severity values(processCommandLine) as process values(ipAddress) as ip_address values(registryKey) as registry_key values(url) as url values(mitreTechniques{}) as annotations.mitre_attack.mitre_technique_id values(signature) as signature values(user) as user values(risk_score) as risk_score BY id description dest | \security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | where count > 0`
Requires Splunk Add-on for Microsoft Security; dynamically maps techniques like T1566.002 (Phishing: Spearphishing Attachment). Tune risk scores based on environment.
Microsoft Defender ATP Alerts (TTP Aggregation)
Leverages alerts from Microsoft Defender for Endpoint (ATP) to summarize threats including processes, files, and IPs, enabling correlation for broader attack chain analysis (maps to various MITRE tactics like Execution, Persistence).
index=xdr sourcetype=ms365:defender:atp:alerts (source=* OR user=*) | eval tmp_entities=json_extract(_raw, "entities"), tmp_entitymv=json_array_to_mv(tmp_entities), tmp_filtered_mv=mvfilter(json_extract(tmp_entitymv, "verdict") != "Clean"), fileName = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "fileName")), processCommandLine = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "processCommandLine")), ipAddress = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "ipAddress")), registryKey = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "registryKey")), url = mvmap(tmp_filtered_mv, spath(tmp_filtered_mv, "url")) | eval risk_score=case(severity="informational", 5, severity="low", 15, severity="medium", 25, severity="high", 50, true(), 2) | stats count min(_time) as firstTime max(_time) as lastTime values(fileName) as file_name values(severity) as severity values(processCommandLine) as process values(ipAddress) as ip_address values(registryKey) as registry_key values(url) as url values(mitreTechniques{}) as annotations.mitre_attack.mitre_technique_id values(signature) as signature values(source) as source values(risk_score) as risk_score BY id description | \security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | where count > 0`
Similar to O365 version but for endpoint alerts; integrates with EDR data. False positives from benign alerts; use for incident triage.
Windows Defender ASR Rules Stacking (T1562.001)
Identifies stacking or repeated triggering of Attack Surface Reduction (ASR) rules in Microsoft Defender, indicating potential evasion attempts or targeted attacks (MITRE ATT&CK T1562.001: Impair Defenses: Disable or Modify Tools).
index=xdr sourcetype=win:eventlog:microsoft-windows-windows defender/operational EventID IN (1121,1122,1125,1126,1131,1132,1133,1134) | stats count as rule_triggers min(_time) as firstTime max(_time) as lastTime BY host, EventID, RuleName | where rule_triggers > 5 | \security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table host, RuleName, rule_triggers, firstTime, lastTime`
Threshold of 5 triggers tunable; covers blocked/audited ASR events. Relevant for environments with Defender Exploit Guard enabled.
Malicious PowerShell Process with Obfuscation (T1027)
Detects PowerShell executions with obfuscated command lines (e.g., encoded commands), a common technique for evasion and execution (MITRE ATT&CK T1027: Obfuscated Files or Information). Uses Defender process logs.
index=xdr process_name="powershell.exe" OR process_name="powershell_ise.exe" (command_line="* -enc *" OR command_line="* -encoded *" OR command_line="* -w hidden *") | stats count min(_time) as firstTime max(_time) as lastTime values(command_line) as command_line BY dest, process_name, parent_process_name | where count > 0 | \security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table dest, command_line, firstTime, lastTime`
High-fidelity for malicious activity; false positives from encoded scripts in legit automation. Integrate with AMSI logs for better context.
Disabling LSA Protection via Registry (T1562.001)
Monitors for deletion or modification of registry keys disabling Local Security Authority (LSA) protection in Windows Defender/Device Guard (MITRE ATT&CK T1562.001: Impair Defenses: Disable or Modify Tools).
index=xdr action IN ("registry_delete","registry_set") (registry_path="*\\\\RunAsPPL*" OR registry_path="*\\\\LsaCfgFlags*") registry_value_data=0 | stats count min(_time) as firstTime max(_time) as lastTime values(registry_path) as registry_path values(registry_value_data) as value_data BY dest, user | where count > 0 | \security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` | table dest, user, registry_path, firstTime, lastTime`
Critical for defense evasion; low false positives. Alert on admin accounts performing this outside maintenance windows.



Below is a curated set of high-fidelity correlation candidates you can implement on **Microsoft Defender for XDR** telemetry ingested to Splunk (assuming all events land in **`index=xdr`**). They’re organized across MITRE ATT&CK tactics and reference common Defender schemas (e.g., `DeviceProcessEvents`, `DeviceNetworkEvents`, `DeviceFileEvents`, `DeviceLogonEvents`, `AlertInfo/DeviceAlertEvents`). Adjust field names to your Splunk CIM or your Defender-for-Splunk field mapping (e.g., `event_type`, `device_name`, `account`, `file_path`, `process_name`, `parent_process_name`, `remote_ip`, `alert_title`, `severity`, etc.).

> **Implementation note (recommended normalizations):**
>
> * Normalize to Splunk CIM where possible (Endpoint, Authentication, Malware, Intrusion Detection, Web).
> * Use lookups for *admin tools*, *living-off-the-land binaries (LOLBins)*, *known C2*, *high-risk countries/ASNs*, *service accounts*, *VIP users*.
> * Gate noisy rules with `risk_score`, suppressions (maintenance windows, scanners), and thresholding.

---

### Correlation Use Cases (MITRE-aligned)

| Title                                             | Description                                                                                    | SPL Query (index=xdr)                                                                                                                                                                                                                                                                                                                                                                                                      | Comment                                                                                                                           |                                                                                                         |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| ------------------------------------------------- | ---------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- | ------------------------------------- | ------------------------------------------------- | ------------------------------------------------- | ----------------------------------------------- |
| Suspicious LSASS Access (Mimikatz-like)           | Detect processes accessing LSASS memory or creating LSASS dumps.                               | `index=xdr (event_type=DeviceProcessEvents OR sourcetype="defender:endpoint") process_name IN ("procdump.exe","rundll32.exe","dumpert.exe","outflank\*","taskmgr.exe","lsassy.exe") OR (process_command_line="*lsass* -ma*" OR process_command_line="*comsvcs.dll* MiniDump*") OR (registry_key="HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest" registry_value=UseLogonCredential registry_value_data=1) | stats values(process_command_line) as cmd any(ipv4) as host_ip by device_name, account, process_name, parent_process_name, _time` | ATT&CK: T1003.001; Controls: CIS 18, NIST SI-4; Add allowlist for support tools.                        |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Credential Dumping Alerts from Defender           | Bubble up Defender’s own alerts for credential theft and correlate with host process activity. | `index=xdr (event_type=DeviceAlertEvents OR tag=alert) alert_title IN ("Credential dumping","Possible credential theft","Suspicious access to LSASS")                                                                                                                                                                                                                                                                      | stats count by device_name, account, alert_title, severity                                                                        | where count>=1`                                                                                         | ATT&CK: T1003; Fast-path on native signals; drive Notables for triage.    |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Unusual NTDS.dit / SAM Access                     | Flag attempts to access NTDS/SAM/SECURITY hives.                                               | `index=xdr (event_type=DeviceFileEvents OR DeviceProcessEvents) (file_path="*\Windows\NTDS\NTDS.dit" OR file_path="*\System32\config\SAM" OR file_path="*\System32\config\SECURITY")                                                                                                                                                                                                                                       | stats values(process_command_line) by device_name, account, file_path`                                                            | ATT&CK: T1003.003/T1003.002.                                                                            |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Pass-the-Hash/Over-Pass-the-Hash Indicators       | Look for NTLM logons without Kerberos on servers by non-service users.                         | `index=xdr event_type=DeviceLogonEvents logon_type=Network auth_protocol=NTLM NOT (account IN [                                                                                                                                                                                                                                                                                                                            | inputlookup service_accounts.csv                                                                                                  | fields account])                                                                                        | stats dc(device_name) as hosts,count by account, src_ip                   | where hosts>=2 AND count>=5`                                                                                                     | ATT&CK: T1550.002; tune thresholds.                           |                                       |                                                   |                                                   |                                                 |
| New Local Admin Creation Outside Change Window    | Detect local admin group modifications off-hours.                                              | `index=xdr event_type=DeviceProcessEvents process_name="net.exe" process_command_line="*localgroup administrators * /add*"                                                                                                                                                                                                                                                                                                 | eval hour=strftime(_time,"%H")                                                                                                    | where hour<6 OR hour>20                                                                                 | stats values(process_command_line) by device_name, account`               | ATT&CK: T1098; Map to AU-6/NZ-SI-4.                                                                                              |                                                               |                                       |                                                   |                                                   |                                                 |
| Persistence via Run Keys / Startup Folders        | Registry & startup folder persistence.                                                         | `index=xdr (event_type=DeviceRegistryEvents registry_key="*\Software\Microsoft\Windows\CurrentVersion\Run*" OR event_type=DeviceFileEvents file_path="*\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\*")                                                                                                                                                                                                  | stats values(registry_value_data) as payload by device_name, account, registry_key, file_path`                                    | ATT&CK: T1547.                                                                                          |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Service Install/Change (sc.exe, PowerShell)       | New or modified Windows services.                                                              | `index=xdr event_type=DeviceProcessEvents (process_name="sc.exe" OR process_name="powershell.exe") process_command_line="*create * binPath=*" OR process_command_line="*config * binPath=*"                                                                                                                                                                                                                                | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1543.003; Add signer checks.                                                                   |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Scheduled Task Persistence                        | Creation of suspicious scheduled tasks.                                                        | `index=xdr event_type=DeviceProcessEvents process_name IN ("schtasks.exe","at.exe") process_command_line="*/Create*"                                                                                                                                                                                                                                                                                                       | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1053.005.                                                                                      |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| In-Memory PowerShell with Obfuscation             | Indicators of obfuscation and download-exec.                                                   | `index=xdr event_type=DeviceProcessEvents process_name="powershell.exe" (process_command_line="*FromBase64String*" OR process_command_line="*IEX*" OR process_command_line="*DownloadString*" OR process_command_line="*invoke-expression*" OR process_command_line="*ExecutionPolicy Bypass*")                                                                                                                            | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1059.001/T1027.                                                                                |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| LOLBins for Payload Staging                       | Suspicious use of `bitsadmin`, `certutil`, `rundll32`, `mshta`, `regsvr32`.                    | `index=xdr event_type=DeviceProcessEvents process_name IN ("bitsadmin.exe","certutil.exe","rundll32.exe","mshta.exe","regsvr32.exe")                                                                                                                                                                                                                                                                                       | stats values(process_command_line) by device_name, account, process_name`                                                         | ATT&CK: T1105/T1218; keep an allowlist for legitimate uses.                                             |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| WMI Lateral Movement                              | WMI process execution remotely.                                                                | `index=xdr event_type=DeviceProcessEvents process_name="wmic.exe" OR process_command_line="* /node:* process call create *"                                                                                                                                                                                                                                                                                                | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1047.                                                                                          |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Remote Service Creation Across Hosts              | New services created from a remote source IP hitting multiple hosts.                           | `index=xdr event_type=DeviceProcessEvents process_name="sc.exe" process_command_line="* \\* create *"                                                                                                                                                                                                                                                                                                                      | rex field=process_command_line "\\\\(?<target>[^\s]+)"                                                                            | stats dc(target) as targets by src_ip, account                                                          | where targets>=3`                                                         | ATT&CK: T1021.002.                                                                                                               |                                                               |                                       |                                                   |                                                   |                                                 |
| RDP Lateral Movement Burst                        | Multiple successful RDP logons from one source across many hosts.                              | `index=xdr event_type=DeviceLogonEvents logon_type=RemoteInteractive action=Success protocol=RDP                                                                                                                                                                                                                                                                                                                           | stats dc(device_name) as hosts, values(device_name) as host_list by src_ip, account                                               | where hosts>=5`                                                                                         | ATT&CK: T1021.001; add geo/ASN risk.                                      |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| SMB Lateral Movement with Admin Shares            | Connections to ADMIN$, C$, IPC$ from non-admin users.                                          | `index=xdr event_type=DeviceNetworkEvents (destination_port IN (139,445)) share_name IN ("ADMIN$","C$","IPC$") NOT [                                                                                                                                                                                                                                                                                                       | inputlookup admin_users.csv                                                                                                       | fields account]                                                                                         | stats count by src_ip, account, device_name, share_name`                  | ATT&CK: T1021.002.                                                                                                               |                                                               |                                       |                                                   |                                                   |                                                 |
| Kerberoasting Suspected                           | Many SPN ticket requests by single user.                                                       | `index=xdr (event_type=IdentityLogon OR sourcetype="defender:identity") action=TicketGranted spn="*"                                                                                                                                                                                                                                                                                                                       | stats count by account                                                                                                            | where count>=50`                                                                                        | ATT&CK: T1558.003; tune to environment size.                              |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Golden Ticket/Unusual TGT Lifetime                | Abnormal TGT lifetimes or DC-only logons by workstations.                                      | `index=xdr (event_type=IdentityLogon OR DeviceLogonEvents) auth_protocol=Kerberos ticket_lifetime>86400                                                                                                                                                                                                                                                                                                                    | stats avg(ticket_lifetime) by account, src_ip`                                                                                    | ATT&CK: T1558.001.                                                                                      |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious OAuth App Consent (M365)               | New OAuth app with high-priv scopes consented by end-user.                                     | `index=xdr (sourcetype="defender:cloudapps" OR product="MDA") event_subtype="OAuthAppConsent" scopes="*Mail.ReadWrite* OR *Files.ReadWrite.All* OR *offline_access*"                                                                                                                                                                                                                                                       | stats values(app_name) values(scopes) by account, src_ip`                                                                         | ATT&CK: T1528; map to M365 app governance.                                                              |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Impossible Travel (M365/Entra ID)                 | Consecutive logins imply impossible travel time.                                               | `index=xdr sourcetype="defender:identity" action=LoginSuccess                                                                                                                                                                                                                                                                                                                                                              | sort 0 account _time                                                                                                              | streamstats window=2 current=f last(_time) as prev_time last(src_geo) as prev_geo by account            | eval delta=_time-prev_time                                                | where src_geo!=prev_geo AND delta<1800                                                                                           | stats values(src_geo) values(prev_geo) min(delta) by account` | ATT&CK: TA0001; integrate geo lookup. |                                                   |                                                   |                                                 |
| Mailbox Rule for Auto-Forward                     | Suspicious mailbox rule that forwards externally.                                              | `index=xdr sourcetype="defender:office" event_type=MailboxRuleCreated (rule_action="ForwardTo" OR rule_action="RedirectTo")                                                                                                                                                                                                                                                                                                | search recipient_domain!="yourcorp.tld"                                                                                           | stats values(rule_name) values(recipient) by account`                                                   | ATT&CK: T1114.003; regulatory risk.                                       |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Phishing Click → Device Compromise Chain          | Join mail click with endpoint alert within 60 minutes.                                         | `(                                                                                                                                                                                                                                                                                                                                                                                                                         | index=xdr sourcetype="defender:office" event_type=ClickAllowed OR event_type=ClickBlocked                                         | eval join_key=account."                                                                                 | ".mvindex(split(url,"/"),2)                                               | table _time,account,join_key,subject) OR (index=xdr (event_type=DeviceAlertEvents OR tag=alert) severity IN ("High","Critical")) | eval join_key=coalesce(join_key,account)                      | transaction join_key maxspan=60m      | search sourcetype="defender:office" AND tag=alert | table _time,account,subject,alert_title,severity` | ATT&CK: TA0001→TA0002 chain; good for Notables. |
| Suspicious Macro/Office Child Process             | Office spawning script/LOLBin.                                                                 | `index=xdr event_type=DeviceProcessEvents parent_process_name IN ("winword.exe","excel.exe","powerpnt.exe") process_name IN ("cmd.exe","powershell.exe","wscript.exe","cscript.exe","mshta.exe","rundll32.exe","regsvr32.exe")                                                                                                                                                                                             | stats values(process_command_line) by device_name, account, parent_process_name, process_name`                                    | ATT&CK: T1204.002/T1059.                                                                                |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| PDF/ISO/IMG → Script Execution                    | File types commonly used to stage malware leading to script.                                   | `index=xdr (event_type=DeviceFileEvents file_extension IN ("iso","img","vhd","lnk","js","vbs","ps1") OR event_type=DeviceProcessEvents parent_process_name IN ("explorer.exe","7zFM.exe"))                                                                                                                                                                                                                                 | stats values(file_name) values(process_command_line) by device_name, account`                                                     | ATT&CK: T1204/T1566.001.                                                                                |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| C2 Beacons to Known Bad/Anomalous ASN             | Outbound to known C2 or new ASN for host.                                                      | `index=xdr event_type=DeviceNetworkEvents action=Allowed direction=Outbound                                                                                                                                                                                                                                                                                                                                                | lookup c2_reputation ioc_ip as remote_ip OUTPUT category                                                                          | lookup asset_asn_lookup device_name OUTPUT last_asn as baseline_asn                                     | where category="malicious" OR asn!=baseline_asn                           | stats values(remote_ip) values(remote_port) by device_name`                                                                      | ATT&CK: T1071; maintain threat intel lookups.                 |                                       |                                                   |                                                   |                                                 |
| DNS Tunneling Heuristics                          | High entropy/length subdomains and volume.                                                     | `index=xdr event_type=DeviceNetworkEvents protocol=DNS                                                                                                                                                                                                                                                                                                                                                                     | eval sld_len=len(domain), label_count=len(split(domain,"."))                                                                      | stats count avg(sld_len) as alen by device_name, domain                                                 | where alen>45 OR count>500`                                               | ATT&CK: T1071.004; add entropy calc (UDTF/py).                                                                                   |                                                               |                                       |                                                   |                                                   |                                                 |
| PowerShell Download-Exec to External              | PowerShell reaching external IPs then writing executable.                                      | `index=xdr (event_type=DeviceProcessEvents process_name="powershell.exe" AND process_command_line="*DownloadString*") OR (event_type=DeviceFileEvents file_extension IN ("exe","dll") AND action=Created)                                                                                                                                                                                                                  | transaction device_name maxspan=15m                                                                                               | search process_name="powershell.exe" action=Created                                                     | table _time,device_name,account,process_command_line,file_name`           | ATT&CK: T1105/T1059.001.                                                                                                         |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious Zip/Exfil in User Profile              | Large archive creation in %USERPROFILE% followed by external upload.                           | `index=xdr (event_type=DeviceFileEvents action=Created file_extension IN ("zip","7z","rar")) OR (event_type=DeviceNetworkEvents direction=Outbound bytes_out>50000000)                                                                                                                                                                                                                                                     | transaction device_name account maxspan=20m                                                                                       | search file_extension=* AND bytes_out>50000000                                                          | table _time,device_name,account,file_name,bytes_out,remote_ip`            | ATT&CK: T1560/T1041.                                                                                                             |                                                               |                                       |                                                   |                                                   |                                                 |
| Cloud Credential Harvest (AWS/Azure/GCP Files)    | Access to cloud creds files then network exfil.                                                | `index=xdr (event_type=DeviceFileEvents file_path IN ("*\AppData\Roaming\AWS\credentials","*\Azure\TokenCache","*\gcloud\application_default_credentials.json","*/.aws/credentials","*/.azure/*","*/.config/gcloud/*")) OR (event_type=DeviceNetworkEvents direction=Outbound bytes_out>10000000)                                                                                                                          | transaction device_name account maxspan=30m                                                                                       | search file_path=* AND bytes_out>10000000`                                                              | ATT&CK: T1552.                                                            |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Shadow Copies Deletion                            | Ransomware behavior removing backups.                                                          | `index=xdr event_type=DeviceProcessEvents process_command_line="*vssadmin* delete shadows*" OR process_command_line="*wmic shadowcopy delete*"                                                                                                                                                                                                                                                                             | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1490; high-fidelity.                                                                           |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| File Encryption Surge                             | Spike in file modifications with `*.encrypted`/entropy.                                        | `index=xdr event_type=DeviceFileEvents action=Modified                                                                                                                                                                                                                                                                                                                                                                     | eval ext=lower(mvindex(split(file_name,"."),-1))                                                                                  | stats count by device_name, ext span=5m                                                                 | where count>100 AND (ext="encrypted" OR ext="lock" OR ext="locked")`      | ATT&CK: T1486; combine with known ransomware notes.                                                                              |                                                               |                                       |                                                   |                                                   |                                                 |
| Rclone/7zip Exfil Pattern                         | Known tools for staging/exfil.                                                                 | `index=xdr event_type=DeviceProcessEvents process_name IN ("rclone.exe","rclone","7z.exe","7zr.exe")                                                                                                                                                                                                                                                                                                                       | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1041/T1560.                                                                                    |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Living-off-Land: `esxcli` / Hypervisor Targeting  | Attempts to impact hypervisors/VM stores.                                                      | `index=xdr event_type=DeviceProcessEvents process_name IN ("esxcli","vim-cmd") OR process_command_line="* /vmfs/volumes/*"                                                                                                                                                                                                                                                                                                 | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1496/T1489; scope for virtualization mgmt hosts.                                               |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspect Remote PowerShell (WinRM)                 | Many `powershell.exe` with `-EncodedCommand` from one src IP across hosts.                     | `index=xdr event_type=DeviceProcessEvents process_name="powershell.exe" process_command_line="*-EncodedCommand*"                                                                                                                                                                                                                                                                                                           | stats dc(device_name) as hosts values(device_name) as host_list by src_ip                                                         | where hosts>=3`                                                                                         | ATT&CK: T1021.006/T1059.001.                                              |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Disable Security Tools                            | Attempts to stop Defender/EDR services.                                                        | `index=xdr event_type=DeviceProcessEvents (process_command_line="*Set-MpPreference*" OR process_command_line="*DisableRealtimeMonitoring*" OR process_command_line="*sc stop*Sense*" OR process_command_line="*mpcmdrun* -RemoveDefinitions*")                                                                                                                                                                             | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1562.001.                                                                                      |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious Registry for RDP/Sticky Keys Backdoor  | Enable RDP/NLA off or sticky keys replacement.                                                 | `index=xdr event_type=DeviceRegistryEvents (registry_key="*\Control\Terminal Server\fDenyTSConnections" AND registry_value_data=0) OR (registry_key="*\Image File Execution Options\sethc.exe\Debugger")                                                                                                                                                                                                                   | stats values(registry_value_data) by device_name, account, registry_key`                                                          | ATT&CK: T1112/T1546.008.                                                                                |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Web Shell Indicators on IIS                       | Creation of ASP/ASPX/JS in webroots + network egress.                                          | `index=xdr (event_type=DeviceFileEvents file_path="*\inetpub\wwwroot\*.asp*" action=Created) OR (event_type=DeviceNetworkEvents direction=Outbound bytes_out>1000000)                                                                                                                                                                                                                                                      | transaction device_name maxspan=15m                                                                                               | search file_path="*inetpub\wwwroot*" AND bytes_out>1000000`                                             | ATT&CK: T1505.003/T1105.                                                  |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Constrained Language Mode Disabled                | PowerShell CLM turned off.                                                                     | `index=xdr event_type=DeviceProcessEvents process_name="powershell.exe" process_command_line="*-ExecutionPolicy Bypass*"                                                                                                                                                                                                                                                                                                   | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1562/T1059.001.                                                                                |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious `wmiprvse.exe` Spawns                  | `wmiprvse.exe` spawning unusual children.                                                      | `index=xdr event_type=DeviceProcessEvents parent_process_name="wmiprvse.exe"                                                                                                                                                                                                                                                                                                                                               | stats values(process_name) values(process_command_line) by device_name, account                                                   | search NOT process_name IN ("dllhost.exe","svchost.exe")`                                               | ATT&CK: T1047/T1059.                                                      |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Abnormal Admin Tool from Non-Admin User           | Use of admin tools by users not in admin groups.                                               | `index=xdr event_type=DeviceProcessEvents process_name IN ("psexec.exe","wmic.exe","sc.exe","reg.exe","netsh.exe") NOT [                                                                                                                                                                                                                                                                                                   | inputlookup admin_users.csv                                                                                                       | fields account]                                                                                         | stats values(process_command_line) by device_name, account, process_name` | ATT&CK: T1036/T1021.                                                                                                             |                                                               |                                       |                                                   |                                                   |                                                 |
| PrinterNightmare/Spooler Abuse                    | Spooler service exploitation patterns.                                                         | `index=xdr event_type=DeviceProcessEvents process_command_line="*spoolsv*" OR (registry_key="*\Print\Environments\Windows x64\Drivers\Version-3*")                                                                                                                                                                                                                                                                         | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1068 (Priv-Esc).                                                                               |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Certificate Export / Private Key Access           | Export of certs/keys via certutil/PowerShell.                                                  | `index=xdr event_type=DeviceProcessEvents (process_name="certutil.exe" AND process_command_line="*-exportPFX*") OR process_command_line="*Get-ChildItem Cert:\* -Recurse*"                                                                                                                                                                                                                                                 | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1552.004/T1555.                                                                                |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| High-Risk Fileless (AMSI/Script) Alerts           | Escalate Defender’s AMSI/script-based detections.                                              | `index=xdr (event_type=DeviceAlertEvents OR tag=alert) (alert_title="Suspicious script" OR alert_title="Malicious PowerShell" OR category="Fileless") severity IN ("High","Critical")                                                                                                                                                                                                                                      | stats count by device_name, account, alert_title`                                                                                 | ATT&CK: T1059/T1216.                                                                                    |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Excessive Failed Logons → Success                 | Brute force followed by success within 10 min.                                                 | `index=xdr event_type=DeviceLogonEvents                                                                                                                                                                                                                                                                                                                                                                                    | bin _time span=10m                                                                                                                | stats sum(eval(action="Failure")) as fails, sum(eval(action="Success")) as succ by account, src_ip, bin | where fails>=20 AND succ>=1`                                              | ATT&CK: T1110; throttle by src ASN.                                                                                              |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious Use of `ntdsutil`/`diskshadow`         | Backup/restore tooling for data theft.                                                         | `index=xdr event_type=DeviceProcessEvents process_name IN ("ntdsutil.exe","diskshadow.exe")                                                                                                                                                                                                                                                                                                                                | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1003/T1560.                                                                                    |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| New Binary in Startup + Unsigned                  | Unsigned binary written to Startup and executed.                                               | `index=xdr event_type=DeviceFileEvents file_path="*\Startup\*" signature_status="Unsigned"                                                                                                                                                                                                                                                                                                                                 | join device_name,file_hash [ search index=xdr event_type=DeviceProcessEvents file_hash=* ]                                        | stats values(file_name) values(process_name) by device_name, account`                                   | ATT&CK: T1547.                                                            |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious Inbound PowerShell Remoting            | Many inbound 5985/5986 from a single IP.                                                       | `index=xdr event_type=DeviceNetworkEvents destination_port IN (5985,5986) action=Allowed                                                                                                                                                                                                                                                                                                                                   | stats dc(device_name) as hosts, values(device_name) as host_list by src_ip                                                        | where hosts>=5`                                                                                         | ATT&CK: T1021.006.                                                        |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Encrypted Archive Egress to Cloud Storage         | New archive → upload to storage domains.                                                       | `index=xdr (event_type=DeviceFileEvents file_extension IN ("7z","rar","zip")) OR (event_type=DeviceNetworkEvents domain IN ("*.mega.nz","*.dropbox.com","*.box.com","*.drive.google.com") bytes_out>20000000)                                                                                                                                                                                                              | transaction device_name account maxspan=30m                                                                                       | search file_extension=* AND bytes_out>20000000`                                                         | ATT&CK: T1041/T1567.                                                      |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious `taskkill` of Security Tools           | Killing EDR/AV.                                                                                | `index=xdr event_type=DeviceProcessEvents process_name="taskkill.exe" process_command_line="*/F /IM *defender* OR */F /IM *sense* OR */F /IM *msmpeng*"                                                                                                                                                                                                                                                                    | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1562.001.                                                                                      |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Mass File Rename to Same Extension                | Ransomware note or encryptor behavior.                                                         | `index=xdr event_type=DeviceFileEvents action=Renamed                                                                                                                                                                                                                                                                                                                                                                      | rex field=file_name "(?<ext>\.[^.]+)$"                                                                                            | stats count by device_name, ext span=5m                                                                 | where count>500`                                                          | ATT&CK: T1486.                                                                                                                   |                                                               |                                       |                                                   |                                                   |                                                 |
| New External IP Beacon from Server Tier           | Server begins talking to new Internet IP never seen before.                                    | `index=xdr event_type=DeviceNetworkEvents direction=Outbound category=server                                                                                                                                                                                                                                                                                                                                               | lookup asset_profile device_name OUTPUT baseline_outbound_ips                                                                     | where NOT match(remote_ip, baseline_outbound_ips)                                                       | stats values(remote_ip) by device_name`                                   | ATT&CK: T1071; maintain baselines.                                                                                               |                                                               |                                       |                                                   |                                                   |                                                 |
| `regsvr32` with Remote Scriptlet                  | Squiblydoo pattern.                                                                            | `index=xdr event_type=DeviceProcessEvents process_name="regsvr32.exe" process_command_line="*/i:http* scrobj.dll*"                                                                                                                                                                                                                                                                                                         | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1218.010.                                                                                      |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| `mshta` with Remote HTA                           | Remote HTA execution.                                                                          | `index=xdr event_type=DeviceProcessEvents process_name="mshta.exe" process_command_line="*http*\.hta*"                                                                                                                                                                                                                                                                                                                     | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1218.005.                                                                                      |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| `rundll32` with JavaScript/Control_RunDLL         | LOLBin abuse pattern.                                                                          | `index=xdr event_type=DeviceProcessEvents process_name="rundll32.exe" process_command_line="*javascript:*" OR process_command_line="*Control_RunDLL*"                                                                                                                                                                                                                                                                      | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1218.011.                                                                                      |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| `bitsadmin` External Download                     | Background Intelligent Transfer misuse.                                                        | `index=xdr event_type=DeviceProcessEvents process_name="bitsadmin.exe" process_command_line="*/transfer * http*/*"                                                                                                                                                                                                                                                                                                         | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1197.                                                                                          |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious `curl`/`Invoke-WebRequest` + Write     | CLI download followed by write/exec.                                                           | `index=xdr event_type=DeviceProcessEvents (process_name IN ("curl.exe","wget.exe") OR process_command_line="*Invoke-WebRequest* -OutFile *") OR (event_type=DeviceFileEvents action=Created file_extension IN ("exe","dll","ps1"))                                                                                                                                                                                         | transaction device_name maxspan=10m                                                                                               | search process_name=* AND action=Created`                                                               | ATT&CK: T1105/T1204.                                                      |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Brute Force Against OWA/Graph                     | Excessive failures to O365 endpoints.                                                          | `index=xdr sourcetype="defender:office" event_type=Login action=Failure domain IN ("login.microsoftonline.com","outlook.office365.com")                                                                                                                                                                                                                                                                                    | stats count by src_ip, account span=10m                                                                                           | where count>=50`                                                                                        | ATT&CK: T1110; add country filters.                                       |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| MFA Fatigue (Push Bombing)                        | Many MFA prompts declined by same user shortly before success.                                 | `index=xdr sourcetype="defender:identity" event_subtype="MFA"                                                                                                                                                                                                                                                                                                                                                              | stats sum(eval(result="Deny")) as denies, sum(eval(result="Allow")) as allows by account, span=15m                                | where denies>=10 AND allows>=1`                                                                         | ATT&CK: T1621.                                                            |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious `net use` to Admin Shares              | Command line lateral movement.                                                                 | `index=xdr event_type=DeviceProcessEvents process_name="net.exe" process_command_line="* use *\\*\ADMIN$*"                                                                                                                                                                                                                                                                                                                 | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1021.002.                                                                                      |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| New `AuthorizedKeys` on Linux                     | SSH persistence via keys.                                                                      | `index=xdr (event_type=DeviceFileEvents file_path="*/.ssh/authorized_keys" action IN ("Created","Modified"))                                                                                                                                                                                                                                                                                                               | stats values(file_path) by device_name, account`                                                                                  | ATT&CK: T1098.                                                                                          |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Sudden Increase in `sudo` Failures                | Linux brute force attempts.                                                                    | `index=xdr sourcetype="defender:linux" event_type=Auth action=Failure command="sudo"                                                                                                                                                                                                                                                                                                                                       | stats count by account, src_ip span=10m                                                                                           | where count>=20`                                                                                        | ATT&CK: T1110.                                                            |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| `crontab` Persistence                             | Suspicious cron entries.                                                                       | `index=xdr sourcetype="defender:linux" event_type=Process process_name="crontab" (process_command_line="*-e*" OR process_command_line="*-l*")                                                                                                                                                                                                                                                                              | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: T1053.003.                                                                                      |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Kubernetes Token/Secrets Access from Host         | Access to kube tokens/secret paths.                                                            | `index=xdr event_type=DeviceFileEvents file_path IN ("/var/run/secrets/kubernetes.io/*","/var/run/secrets/kubernetes.io/serviceaccount/token")                                                                                                                                                                                                                                                                             | stats count by device_name, account, file_path`                                                                                   | ATT&CK: T1552.                                                                                          |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious `adb`/Mobile Bridge on Windows         | Unexpected Android Debug Bridge usage on corp endpoints.                                       | `index=xdr event_type=DeviceProcessEvents process_name="adb.exe"                                                                                                                                                                                                                                                                                                                                                           | stats values(process_command_line) by device_name, account`                                                                       | ATT&CK: Recon/Exfil vectors.                                                                            |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Untrusted Macro Settings Changed                  | Office macro policy weakened.                                                                  | `index=xdr event_type=DeviceRegistryEvents registry_key="*\Security\Trust Center\VBAWarnings" registry_value_data=1                                                                                                                                                                                                                                                                                                        | stats values(registry_value_data) by device_name, account`                                                                        | ATT&CK: T1562.                                                                                          |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Insecure PowerShell Logging Disabled              | Module/script block logging turned off.                                                        | `index=xdr event_type=DeviceRegistryEvents registry_key="*\PowerShell\ScriptBlockLogging\EnableScriptBlockLogging" registry_value_data=0                                                                                                                                                                                                                                                                                   | stats count by device_name`                                                                                                       | ATT&CK: T1562.                                                                                          |                                                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |
| Suspicious `proc_creation` Surge by Single Parent | Parent spawns many children of diverse names.                                                  | `index=xdr event_type=DeviceProcessEvents                                                                                                                                                                                                                                                                                                                                                                                  | stats dc(process_name) as uniq_procs count by parent_process_name, device_name span=5m                                            | where uniq_procs>=20 AND count>=50`                                                                     | ATT&CK: T1055/T1106 heuristics.                                           |                                                                                                                                  |                                                               |                                       |                                                   |                                                   |                                                 |

---

## Deployment Guidance (concise)

* **Severity & Triage:** Start “High/Critical” for ransomware, credential dumping, EDR tamper, Golden Ticket, C2 beacons, DNS tunneling.
* **Noise Control:** Add **allowlists** (IT tools, admin users, maintenance windows), threshold by **host cardinality** and **event rate**, and **suppress** duplicates for N minutes.
* **Risk-Based Alerting:** Enrich with risk modifiers (VIP users, crown-jewel hosts, DCs), geo/ASN risk, device exposure (internet-facing, non-compliant).
* **Data Health:** Ensure Defender connectors populate consistent fields; backfill **lookups** (`service_accounts.csv`, `admin_users.csv`, `c2_reputation.csv`, `asset_profile.csv`, `asset_asn_lookup.csv`).
* **Linkage to Response:** Attach **Notable** playbooks (isolate device via MDE, collect timeline, suspend user in Entra ID, revoke tokens, block indicators in MDE, quarantine mail, disable inbox rule, force password reset & token revocation, snapshot VM).

If you want, I can package these into **Splunk ES Notables** with recommended severities, suppression windows, drilldown panels, **risk-based alerting** scores, and stub **SOAR** playbooks for immediate containment.




